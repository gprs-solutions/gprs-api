name: ğŸš€ Deployment

description: Upload files to FTP server

inputs:
  ftp-server:
    description: 'The FTP server URL'
    required: true
  ftp-user:
    description: 'The FTP username'
    required: true
  ftp-password:
    description: 'The FTP password'
    required: true
  SSH_PRIVATE_KEY:
    description: 'The SSH private key'
    required: true
  SSH_HOST:
    description: 'The SSH host'
    required: true
  SSH_USER:
    description: 'The SSH user'
    required: true
  APP_URL:
    description: 'The Application url'
    required: true
  migrate:
    description: 'Wheather the user wants to make a migration after deploy or not'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”‘ Set up SSH agent
      uses: webfactory/ssh-agent@v0.5.3
      with:
        ssh-private-key: ${{ inputs.SSH_PRIVATE_KEY }}

    - name: ğŸ” Add server to known_hosts
      shell: bash
      run: |
        ssh-keyscan -p 2222 ${{ inputs.SSH_HOST }} >> ~/.ssh/known_hosts

    - name: ğŸ“¦ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: laravel-build
        path: ./laravel-build/

    - name: ğŸ”„ Sync code with server
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ inputs.ftp-server }}
        username: ${{ inputs.ftp-user }}
        password: ${{ inputs.ftp-password }}
        local-dir: ./laravel-build/

    - name: ğŸ“‚ Extract Laravel project
      shell: bash
      run: |
        ssh -p 2222 ${{ inputs.SSH_USER }} "tar -xzf ./${{ inputs.APP_URL }}/laravel-build.tar.gz -C ./${{ inputs.APP_URL }} && rm -f ./${{ inputs.APP_URL }}/laravel-build.tar.gz"

    - name: ğŸ“¦ Install dependencies
      shell: bash
      run: |
        ssh -p 2222 ${{ inputs.SSH_USER }} "cd ./${{ inputs.APP_URL }} && /opt/cpanel/composer/bin/composer install"

    - name: ğŸ§¹ Delete composer files
      shell: bash
      run: |
        ssh -p 2222 ${{ inputs.SSH_USER }} "cd ./${{ inputs.APP_URL }} && rm -f composer.lock && rm -f composer.json"

    - name: ğŸ§¼ Clear Laravel cache
      shell: bash
      run: |
        ssh -p 2222 ${{ inputs.SSH_USER }} "cd ./${{ inputs.APP_URL }} && php artisan config:clear && php artisan route:cache"

    - name: ğŸ› ï¸ Migrate database
      shell: bash
      if: ${{ inputs.migrate == 'true' }}
      run: |
        ssh -p 2222 ${{ inputs.SSH_USER }} "cd ./${{ inputs.APP_URL }} && php artisan migrate:fresh && php artisan migrate --force"
