name: ðŸš€ Deployment

description: Upload files to FTP server

inputs:
  ftp-server:
    description: 'The FTP server URL'
    required: true
  ftp-user:
    description: 'The FTP username'
    required: true
  ftp-password:
    description: 'The FTP password'
    required: true
  SSH_PRIVATE_KEY:
    description: 'The SSH private key'
    required: true
  SSH_PASSPHRASE:
    description: 'The SSH passphrase'
    required: true
  SSH_USER:
    description: 'The SSH user'
    required: true

runs:
  using: 'composite'
  steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: laravel-build
        path: ./laravel-build/

    - name: Set up SSH
      shell: bash
      run: |
        # Create the .ssh directory if it doesn't exist
        mkdir -p ~/.ssh
    
        # Write the private key to a file, using the name 'github' instead of 'id_rsa'
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/github
        chmod 600 ~/.ssh/github
    
        # Start the ssh-agent and add the private key with the passphrase
        eval "$(ssh-agent -s)"
        echo "${{ secrets.SSH_PASSPHRASE }}" | ssh-add ~/.ssh/github
    
        # Configure SSH to only use the specified private key
        echo "Host gprssolutions.com.br" > ~/.ssh/config
        echo "  IdentityFile ~/.ssh/github" >> ~/.ssh/config  # Use 'github' as the private key file
        echo "  IdentitiesOnly yes" >> ~/.ssh/config
        echo "  User github" >> ~/.ssh/config  # Replace 'test' with the actual SSH username
        echo "  Port 2222" >> ~/.ssh/config
    
        # Add your server to known_hosts to avoid interaction
        ssh-keyscan gprssolutions.com.br >> ~/.ssh/known_hosts
    
    - name: ðŸ”„ Sync code with server
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ inputs.ftp-server }}
        username: ${{ inputs.ftp-user }}
        password: ${{ inputs.ftp-password }}
        local-dir: ./laravel-build/

    - name: Decompress build and install dependencies
      shell: bash
      run: |
        ssh -v -p 2222 ${{ inputs.SSH_USER }} "ls -lf"
