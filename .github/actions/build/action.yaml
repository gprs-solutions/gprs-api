name: üèóÔ∏è Laravel build and upload

description: Build and upload Laravel files to server

inputs:
  APP_NAME:
    description: 'The application name'
    required: true
    default: 'Laravel'
  APP_ENV:
    description: 'The application environment'
    required: true
    default: 'production'
  APP_KEY:
    description: 'The application key'
    required: true
  APP_DEBUG:
    description: 'Enable or disable debug mode'
    required: true
    default: 'false'
  APP_URL:
    description: 'The application URL'
    required: true

  LOG_CHANNEL:
    description: 'The log channel'
    required: true
    default: 'stack'
  LOG_LEVEL:
    description: 'Log level'
    required: true
    default: 'warning'

  APP_LOCALE:
    description: 'Application locale'
    required: true
    default: 'pt'

  DB_CONNECTION:
    description: 'Database connection type'
    required: true
    default: 'mysql'
  DB_HOST:
    description: 'Database host'
    required: true
    default: '127.0.0.1'
  DB_PORT:
    description: 'Database port'
    required: true
    default: '3306'
  DB_DATABASE:
    description: 'Database name'
    required: true
  DB_USERNAME:
    description: 'Database username'
    required: true
  DB_PASSWORD:
    description: 'Database password'
    required: true

  JWT_SECRET:
    description: 'JWT secret key'
    required: true
  JWT_ALGO:
    description: 'JWT algorithm'
    required: true
    default: 'HS256'
  JWT_EXPIRY:
    description: 'JWT token expiry time in seconds'
    required: true
    default: '3600'

runs:
  using: 'composite'
  steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üöÄ Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        tools: composer

    - name: üßπ Delete non necessary folders
      shell: bash
      run: |
        rm -rf storage/logs/
        rm -rf storage/framework/cache/
        rm -rf storage/framework/sessions/
        rm -rf .git/
        rm -rf tests/
        rm -rf public/hot
        rm -rf vendor/
        rm -rf public/
        rm -rf composer.lock
        rm -rf docker-compose.yaml
        rm -rf Dockerfile
        rm -rf phpcs.xml
        rm -rf phpunit.xml

    - name: üèóÔ∏è Build .env file
      shell: bash
      run: |
        touch .env
        for var in APP_NAME APP_ENV APP_KEY APP_DEBUG APP_URL LOG_CHANNEL LOG_LEVEL APP_LOCALE DB_CONNECTION DB_HOST DB_PORT DB_DATABASE DB_USERNAME DB_PASSWORD JWT_SECRET JWT_ALGO JWT_EXPIRY; do
          echo "$var=${{ inputs[$var] }}" >> .env
        done

    - name: compress project
      shell: bash
      run: tar -czf laravel-build.tar.gz .[!.]* *
    
    - name: ‚¨ÜÔ∏è Upload build
      uses: actions/upload-artifact@v4
      with:
        name: laravel-build
        path: ./laravel-build.tar.gz
        retention-days: 1
